{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<h2 class="page-title">배추 생산량 예측하기</h2>

<!-- 🔍 필터 폼 (시도‧연도‧질소) -->
<form method="get" id="filter-form">
    <div class="filter-box">

    <!-- 시도 단일 선택 -->
    <div class="sido-checkboxes">
        {% for sido in sido_list %}
            <label>
            <input type="checkbox" class="sido-check"
                    name="sido" value="{{ sido }}"
                    {% if sido == selected_sido %}checked{% endif %}>
            {{ sido }}
            </label>
        {% endfor %}
    </div>

    <hr class="filter-divider">

    <!-- 연도 단일 선택 -->
    <div class="year-filter-row">
        {% for year in year_list %}
            <label>
            <input type="checkbox" class="year-check"
                    name="year" value="{{ year }}"
                    {% if year|stringformat:"s" == selected_year %}checked{% endif %}>
            {{ year }}
            </label>
        {% endfor %}
    </div>

    <hr class="filter-divider">

    <!-- 질소 입력 + 검색 버튼 -->
    <div class="nitrogen-filter-row">
        <input type="number" name="nitrogen"
                step="1" min="0"
                class="nitrogen-input"
                placeholder="질소값 (예: 20)"
                value="{{ nitrogen|default:'' }}">
        <button type="submit" class="inline-search-button">검색</button>
        </div>
    </div>
</form>

<!-- 결과 테이블 (폼 밖) -->
<table class="weatherforecast-table">
    <thead>
        <tr>
        <th>평균기온 (℃)</th>
        <th>평균습도 (%)</th>
        <th>평균풍속 (m/s)</th>
        <th>평균일사량 (MJ/㎡)</th>
        <th>평균강수량 (mm)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
        <td>{{ weather_stats.avg_temp }}</td>
        <td>{{ weather_stats.humidity }}</td>
        <td>{{ weather_stats.wind_speed }}</td>
        <td>{{ weather_stats.solar_radiation }}</td>
        <td>{{ weather_stats.avg_precipitation }}</td>
        </tr>
    </tbody>
</table>

<!-- 🔻 예측 결과 테이블 -->
<table class="prediction-result-table">
    <thead>
        <tr>
            <th>예측값</th>
            <th>실제값</th>
            <th>오차율 (%)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ prediction|default:"-" }}</td>
            <td>{{ actual|default:"-" }}</td>
            <td>{{ error_rate|default:"-" }}</td>
        </tr>
    </tbody>
</table>


<!-- ✅ 단일 선택 스크립트 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 하나만 선택되도록 제어
    document.querySelectorAll('.sido-check').forEach(cb => {
        cb.addEventListener('change', () => {
        if (cb.checked) {
            document.querySelectorAll('.sido-check').forEach(o => { if (o !== cb) o.checked = false; });
        }
        });
    });
    document.querySelectorAll('.year-check').forEach(cb => {
        cb.addEventListener('change', () => {
        if (cb.checked) {
            document.querySelectorAll('.year-check').forEach(o => { if (o !== cb) o.checked = false; });
        }
        });
    });
});

// 새로고침(F5) 시 파라미터 제거해 초기화
window.addEventListener('pageshow', e => {
    if (e.persisted || (performance && performance.navigation.type === 1)) {
    window.location.replace('/cabbageforecast/');
    }
});
</script>
{% endblock %}
