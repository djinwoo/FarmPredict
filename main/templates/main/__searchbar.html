{% load static %}
<form method="get">
    <div class="top-section">
        <label for="sido">ì‹œÂ·ë„ ì„ íƒ :</label>
        <select id="sido" name="sido">
            <option value="">ì‹œÂ·ë„ ì„ íƒ</option>
        </select>

        <label for="sigungu">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ :</label>
        <select id="sigungu" name="sigungu">
            <option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>
        </select>

        <label for="eupmyeondong">ìÂ·ë©´Â·ë™ ì„ íƒ :</label>
        <select id="eupmyeondong" name="eupmyeondong">
            <option value="">ìÂ·ë©´Â·ë™ ì„ íƒ</option>
        </select>

        <button type="submit" class="search-button">
            <img src="{% static 'images/Search-icon.svg' %}" alt="ê²€ìƒ‰">
        </button>
    </div>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const sidoSelect = document.getElementById("sido");
        const sigunguSelect = document.getElementById("sigungu");
        const emdSelect = document.getElementById("eupmyeondong");

        // ğŸ‘‰ ì„ íƒëœ ê°’ë“¤ ìœ ì§€
        const selectedSido = "{{ request.GET.sido|default:'' }}";
        const selectedSigungu = "{{ request.GET.sigungu|default:'' }}";
        const selectedEmd = "{{ request.GET.eupmyeondong|default:'' }}";

        // âœ… ì‹œë„ ë¦¬ìŠ¤íŠ¸ (Pythonì—ì„œ contextë¡œ ì „ë‹¬ í•„ìš”!)
        const sidoList = [
            "ì„œìš¸íŠ¹ë³„ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ",
            "ê²½ê¸°ë„", "ê²½ìƒë‚¨ë„", "ê²½ìƒë¶ë„", "ì „ë¼ë‚¨ë„", "ì¶©ì²­ë‚¨ë„", "ì¶©ì²­ë¶ë„", "ê°•ì›íŠ¹ë³„ìì¹˜ë„",
            "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì œì£¼íŠ¹ë³„ìì¹˜ë„"
        ];

        // ì‹œë„ select ì´ˆê¸°í™”
        sidoList.forEach(function (sido) {
            const option = document.createElement("option");
            option.value = sido;
            option.textContent = sido;
            if (sido === selectedSido) {
                option.selected = true;  // âœ… ì‹œë„ ì„ íƒ ìœ ì§€
            }
            sidoSelect.appendChild(option);
        });

        // ì„ íƒëœ ì‹œë„ì™€ ì‹œêµ°êµ¬ ìˆì„ ë•Œ ì´ˆê¸°í™”
        if (selectedSido) {
            fetchSigungu(selectedSido, selectedSigungu);
        }

        if (selectedSigungu) {
            fetchEupmyeondong(selectedSido, selectedSigungu, selectedEmd);
        }

        // ì‹œë„ ë³€ê²½ ì‹œ ì‹œêµ°êµ¬ ì´ˆê¸°í™”
        sidoSelect.addEventListener("change", function () {
            const sido = this.value;
            sigunguSelect.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
            emdSelect.innerHTML = '<option value="">ìÂ·ë©´Â·ë™ ì„ íƒ</option>';

            if (sido) {
                fetchSigungu(sido, null);
            }
        });

        // ì‹œêµ°êµ¬ ë³€ê²½ ì‹œ ìë©´ë™ ì´ˆê¸°í™”
        sigunguSelect.addEventListener("change", function () {
            const sido = sidoSelect.value;
            const sigungu = this.value;
            emdSelect.innerHTML = '<option value="">ìÂ·ë©´Â·ë™ ì„ íƒ</option>';

            if (sido && sigungu) {
                fetchEupmyeondong(sido, sigungu, null);
            }
        });

        // ì‹œêµ°êµ¬ ê°€ì ¸ì˜¤ê¸°
        function fetchSigungu(sido, selected) {
            fetch(`/get-sigungu/?sido=${encodeURIComponent(sido)}`)
                .then(response => response.json())
                .then(data => {
                    data.sigungu_list.forEach(sigungu => {
                        const option = document.createElement("option");
                        option.value = sigungu;
                        option.textContent = sigungu;
                        if (sigungu === selected) {
                            option.selected = true;
                        }
                        sigunguSelect.appendChild(option);
                    });
                });
        }

        // ìë©´ë™ ê°€ì ¸ì˜¤ê¸°
        function fetchEupmyeondong(sido, sigungu, selected) {
            fetch(`/get-eupmyeondong/?sido=${encodeURIComponent(sido)}&sigungu=${encodeURIComponent(sigungu)}`)
                .then(response => response.json())
                .then(data => {
                    data.eupmyeondong_list.forEach(emd => {
                        const option = document.createElement("option");
                        option.value = emd;
                        option.textContent = emd;
                        if (emd === selected) {
                            option.selected = true;
                        }
                        emdSelect.appendChild(option);
                    });
                });
        }
    });
</script>
