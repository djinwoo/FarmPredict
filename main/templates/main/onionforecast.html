{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<h2 class="page-title">ì–‘íŒŒ ìƒì‚°ëŸ‰ ì˜ˆì¸¡í•˜ê¸°</h2>

<form method="get" id="filter-form">
    <div class="filter-box">

        <!-- ğŸ”· ì‹œë„ ë‹¨ì¼ ì„ íƒ -->
        <div class="sido-checkboxes">
        {% for sido in sido_list %}
        <label>
            <input type="checkbox" class="sido-check"
                name="sido" value="{{ sido }}"
                {% if sido == selected_sido %}checked{% endif %}>
            {{ sido }}
        </label>
        {% endfor %}
        </div>

        <hr class="filter-divider">

        <!-- ğŸ”· ì›” ë‹¤ì¤‘ ì„ íƒ -->
    <div class="year-filter-row">
        <!-- ì „ì²´ì„ íƒ -->
        <label>
            <input type="checkbox" id="select-all-months"> ì „ì²´ì„ íƒ
        </label>

        <!-- 1ì›” ~ 12ì›” -->
        {% for m in month_list %}
            <label>
            <input type="checkbox"
                    class="month-check"
                    name="month"
                    value="{{ m }}"
                    {% if m|stringformat:"s" in selected_months %}checked{% endif %}>
            {{ m }}ì›”
            </label>
        {% endfor %}
    </div>
        <hr class="filter-divider">
        
        <div class="filters-container">
            <div class="year-filter">
                <select name="year" class="year-select">
                    <option value="">ì—°ë„ ì„ íƒ</option>
                    {% for y in year_list %}
                    <option value="{{ y }}"
                            {% if y|stringformat:"s" == selected_year %}selected{% endif %}>
                    {{ y }}ë…„
                    </option>
                    {% endfor %}
                </select>
            </div>
            <!-- ğŸ”· ì§ˆì†Œ ì…ë ¥ + ê²€ìƒ‰ ë²„íŠ¼ -->
            <div class="nitrogen-filter">
            <input type="number" name="nitrogen"
                    step="1" min="0"
                    class="nitrogen-input"
                    placeholder="ì§ˆì†Œê°’ (ì˜ˆ: 20)"
                    value="{{ nitrogen|default:'' }}">
            <button type="submit" class="inline-search-button">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>
    </form>

    <!-- âœ… ê¸°ìƒí‰ê·  í…Œì´ë¸” -->
    <table class="weatherforecast-table">
    <thead>
        <tr>
        <th>í‰ê· ê¸°ì˜¨ (â„ƒ)</th>
        <th>í‰ê· ìŠµë„ (%)</th>
        <th>í‰ê· í’ì† (km/h)</th>
        <th>í•˜ë£¨í‰ê· ì¼ì‚¬ëŸ‰ (MJ/ã¡)</th>
        <th>í•˜ë£¨í‰ê· ê°•ìˆ˜ëŸ‰ (mm)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
        <td>{{ weather_stats.avg_temp }}</td>
        <td>{{ weather_stats.humidity }}</td>
        <td>{{ weather_stats.wind_speed }}</td>
        <td>{{ weather_stats.solar_radiation }}</td>
        <td>{{ weather_stats.avg_precipitation }}</td>
        </tr>
    </tbody>
    </table>

    <!-- ğŸ”» ì˜ˆì¸¡ ê²°ê³¼ í…Œì´ë¸” -->
    <table class="prediction-result-table">
    <thead>
        <tr>
        <th>ì˜ˆì¸¡ê°’ (t/ha)</th>
        <th>ì‹¤ì œê°’ (t/ha)</th>
        <th>ì˜¤ì°¨ìœ¨ (%)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
        <td>{{ prediction|default:"-" }}</td>
        <td>{{ actual|default:"-" }}</td>
        <td>{{ error_rate|default:"-" }}</td>
        </tr>
    </tbody>
    </table>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // âœ… ì‹œë„ ë‹¨ì¼ ì„ íƒ
    document.querySelectorAll('.sido-check').forEach(cb => {
        cb.addEventListener('change', () => {
        if (cb.checked) {
            document.querySelectorAll('.sido-check')
                    .forEach(o => { if (o !== cb) o.checked = false; });
        }
        });
    });

    // âœ… ì „ì²´ ì›” ì„ íƒ & ê°œë³„ ì›” ë™ê¸°í™”
    const selectAll = document.getElementById('select-all-months');
    const monthChecks = document.querySelectorAll('.month-check');

    selectAll.addEventListener('change', () => {
        monthChecks.forEach(cb => cb.checked = selectAll.checked);
    });
    monthChecks.forEach(cb => {
        cb.addEventListener('change', () => {
        selectAll.checked = Array.from(monthChecks).every(c => c.checked);
        });
    });
    });

    // ğŸ”„ ìƒˆë¡œê³ ì¹¨ ì‹œ íŒŒë¼ë¯¸í„° ì œê±°
    window.addEventListener('pageshow', e => {
    if (e.persisted || (performance && performance.navigation.type === 1)) {
        window.location.replace('/onionforecast/');
    }
});
</script>
{% endblock %}
